---
tags:
---

programma della giornata:

###### Problema
Le immagini pubblicate sul registry hanno un ciclo di vita breve dovuto all'implementazione delle retention policy necessarie per minimizzare l'occupazione di spazio sul Registry.

Per tale motivo si è deciso di utilizzare una naming convention che consente di evidenziare le immagini candidate al rilascio in produzione, in modo che esse non vengano cancellate.
A tale scopo si utilizzeranno due pipeline: 
- la pipeline originale, che chiameremo di **build**; questa genererà immagini che verranno cancellate periodicamente;
- la pipeline che genera l'immagine di prod, che chiameremo di **release**; questa genererà immagini da non cancellare dal registry.

###### Procedure
- Si crea una seconda pipeline, e la si chiama
- `"<nome repository>_Pipeline_PROD.yml"(esempio: vedi repository _ENG-Teseo-Next_Audit_BE_)`
- Nella pipeline, il trigger deve essere disabilitato:
```
trigger:
- none
```

- la pipeline deve partire da una commit predefinita, indicata da un tag:
```
 ref: refs/tags/<la mia tag>
```

- la variabile version viene inizializzata con il valore della tag assegnata alla commit da cui si è originata la release candidate:
```
version: Build.SourceBranchName
```

- il name viene ricavato dalla variabile version:
```
name: $(version)
```

- l'immagine viene etichettata con la versione più il suffisso -PROD:
```
tag: '$(version)-PROD'
```

Nel momento in cui l'immagine generata dalla pipeline di build risulta candidata al rilascio:
- si recupera il numero di commit dal log della pipeline di build;
- si recupera la versione dell'immagine generata dalla pipeline di build;
- sul repository del modulo si associa, alla commit recuperata in precedenza, una tag contenente il numero della versione recuperato in precedenza;
- si lancia la pipeline di release dal numero di commit recuperato in precedenza;
- dal sistema target di produzione si scarica l'immagine con la versione recuperata.

La retention policy verrà modificata in modo tale da non cancellare tutte quelle immagini che hanno il suffisso -PROD nel tag.

###### Fonti
- Per il recupero della tag: 
https://stackoverflow.com/questions/56326940/how-to-get-git-tag-in-azure-pipelines

- Per i comandi della pipeline che fanno eseguire la build da una tag: https://stackoverflow.com/questions/75076229/checkout-a-repository-and-specify-a-commit



oggi dopo aver terminato le pipeline di build per i vari repo (quelle per le versioni in produzione da rilasciare in esercizio), mi sono imbattutta in un errore della pipeline riguardante un immagine docker: un tag specificato nella pipeline non risultava all'interno del registry (acr: azure conteiner registry).

forse sono riuscita ad aggiustare un dockerfile. fare installare java runtime a node.js.......
vedremo. la pipeline sta girando....con calma







