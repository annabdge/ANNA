---
cssclasses:
  - martedi
tags:
  - pipeline
  - telerik
  - docker
---
pipeline di VVF_FE
trigger
source
variable
pool definisce macchina virtuale in cui fare la build (ubuntu-latest)

steps:
	task: dockerInstaller@versione
	inputs: 
		dockerversion: 
	displayName (per leggerlo in modo chiaro)

-script: 
(noi facciamo una build multipiattaforma) -> buildx

#### licenza telerik
dall'esterno dobbiam dure al docker cosa deve fare e dove. ha a che fare con la licenza telerik, che viene installata nella pipeline in modalità telerik.


comandi istruzioni di linux (ubuntu) sudo (esegui istruzioni come superuser) si trovano negli steps in `script`... alcuni comandi non andrebero bene per windows..

esercizio. vedi tutti gli script... e leggili e analizza

installare licenza telerik sul container considerando una build multipiattaforma... questa è la pipeline attuale: 
```yaml
# Npm
#
trigger:
  branches:
    include:
      - none

resources:
  - repo: self

name: $(major).$(minor).$(release).$(build)

  
variables:
  #Container registry service connection established during pipeline creation
  AzureSubscription: 'MAE AFM-VVF-DEV'
  dockerRegistryName: 'afmvvf'
  dockerRegistryServiceConnection: 'afmvvf.azurecr.io'
  imageRepository : 'afm/frontend'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  dockerContext: './'

  #Versioning
  major: 0
  minor: 0
  release: 1
  build: $[counter(variables['release'], 0)]
  tag: $(major).$(minor).$(release).$(build)

pool:
  vmImage: 'ubuntu-latest'

steps:

# CONTAINER: install
  - task: DockerInstaller@0
    inputs:
      dockerVersion: '20.10.24'
    displayName: 'Install Docker'

  - script: |
      docker version
    displayName: 'Verifica versione docker'

  - script: |
      docker buildx version
    displayName: 'Verifica versione Docker Buildx'

  - script: |
      sudo apt-get update
      sudo apt-get install docker-compose -y
    displayName: 'Install Docker Compose'

  - script: |
      docker network create afm_network
    displayName: 'Create network afm_network'

# CONTAINER: connection
  - script: |
      echo "Image repository name: " $(imageRepository) 
      echo "Container registry Connection: " $(dockerRegistryServiceConnection)
      echo "Container registry Name: " $(dockerRegistryName)
      echo $(DOCKER_PASSWORD) | docker login $(dockerRegistryServiceConnection) -u $(DOCKER_USERNAME) --password-stdin
    displayName: 'Login to Container Registry'
    env:
      DOCKER_USERNAME: $(DOCKER_USERNAME)
      DOCKER_PASSWORD: $(DOCKER_PASSWORD)    
	  
# Check immagine
#  - task: AzureCLI@2
#    displayName: Checking image version on Azure Repository
#    inputs:
#      azureSubscription: $(AzureSubscription)
#      scriptType: 'bash'
#      scriptLocation: 'inlineScript'
#      inlineScript: ' az acr repository list --name $(dockerRegistryServiceConnection) | grep -q $(imageRepository); if [[ $? == 0 ]]; then az acr repository show-tags --name $(dockerRegistryServiceConnection) --repository $(imageRepository) |  grep -qw \"${VERSION//\./\\.}\"; if [[ $? == 0 ]]; then echo "##vso[task.logissue type=error]Image already present on Azure Image Registry."; exit -1; fi; fi'
#      failOnStandardError: true

# CONTAINER: build multiplatform
  - script: |
      echo $(DOCKER_PASSWORD) | docker login $(dockerRegistryServiceConnection) -u $(DOCKER_USERNAME) --password-stdin
    displayName: 'Login to Container Registry'
    env:
      DOCKER_USERNAME: $(DOCKER_USERNAME)
      DOCKER_PASSWORD: $(DOCKER_PASSWORD)            
  - script: |
      docker run --privileged --rm tonistiigi/binfmt --install all
      docker buildx create --use
      docker buildx inspect --bootstrap
    displayName: 'Abilita Buildx e QEMU per multiarch'

# CONTAINER: publication
  - script: |
      docker buildx build --platform linux/amd64,linux/arm64 \
        -f $(dockerContext)/Dockerfile \
        -t $(dockerRegistryServiceConnection)/$(imageRepository):latest \
        -t $(dockerRegistryServiceConnection)/$(imageRepository):$(tag) \
        . \
        --push
    displayName: 'Build and Push Multi-Arch Image'
```


VVF:Frontend
docker a posto forse

la pipeline l'ha cambiata 
vedi cosa succede--

capire dove scrivere npm ci (con le dipendenze apre npmrc... forse e legge il token da lì), forse sarà da aggiungere il ci nel Dockerfile...

l'npmrc è nel gitignore... menomale ma che è???

se tutto va a buon fine prova a fare la release





