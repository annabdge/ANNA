---
tags:
  - OKD
  - pod
  - Kubernetes
---
ho una nuova agenda.
per ohhi ci sono due cose in programma 

#### vigili del fuoco
docker 

#### teseo
[[2025-11-24 DEFINIZIONI#definizioni|definizioni varie]] e vedi [[2025-11-26#conteinerizzazione|container]]
TODO: 
tirare su l'ambiente di sviluppo su [[2025-11-25#OKD|okd]] attraverso il configmap (uno dei file yaml che costituiscono l'architettura  [[2025-11-25#kubernetes|kubernetes]]) di teseo-svil. nel caso del progetto teseo la tecnologia utilizzata per è OKD, la versione opensource di OpenShift. come abbiamo gia visto è un orchestratore che permett di installare contenitori e gestirli attraverso una configurazione dell'ambiente (configmap), dei servizi, e delle rotte. inoltre si occupa poi di tenere in vita i contenitori (attraverso i [[2025-11-26#Cosa sono i Pod (nel dettaglio pratico)|pod]], le unita piu piccole eseguibili di kubernetes). Una caratteristica è quella di cercare di tenere sempre in vita il pod, anche quando se ne vorrebbe fare partire uno nuovo (per lanciare la versione aggiornata o dopo un bug fixing per esempio), si nota che lui prima cerca di costruire il nuovo pod e solo dopo che ci è riuscito uccide il vecchio. 


##### idea
Fonte: wiki
Per memorizzare le versioni dei singoli moduli si può utilizzare la configmap teseo-version-list.

Condizioni: 
```
- oc.exe copiato sul proprio PC
- il path di oc.exe deve essere inserito nella lista della variabile d'ambiente PATH
```

###### Aggiornamento di un singolo modulo

Esempio: aggiornamento della versione di viewer-fe

1. modifica alla configmap teseo-version-list
![image.png](/.attachments/image-4a0c196c-92ee-4f39-9f4c-2cff92aaa16a.png)
 (la soluzione è estemporanea, in attesa di allestire un automatismo)

2. Apertura powershell e connessione:
`oc login -u sa.alparonel`
se chiede il server, è questo: 
`https://api.clu01.dev.okd.priv:6443 "https://api.clu01.dev.okd.priv:6443/")`
lo si inserisce una volta sola, poi se lo ricorda

3. Shiftare sul progetto di interesse 
Shift su Teseo TEST:   
`oc project cc-teseo`  

Shift su Teseo SVIL:
`oc project cc-teseo-svil`
 
4. Verifica della versione di viewer-fe-deployment salvata nella configmap teseo-version-list:  
```
oc get configmap teseo-version-list -o jsonpath='{.data.viewer-fe-deployment}'
```

5. Verifica della versione presente nel deploy (dovrebbero risultare differenti):  
```
oc get deploy/viewer-fe-deployment -o jsonpath="{..image}"
```
 
6. Modifica del deployment (il pod ripartirà in automatico):
```
oc set image deployment/viewer-fe-deployment viewer-fe=$(oc get configmap teseo-version-list -o jsonpath='{.data.viewer-fe-deployment}')
``` 
 
7. Check versione inserita (ora deve coincidere con quella precedentemente estratta dalla configmap:  
```
oc get deploy/viewer-fe-deployment -o jsonpath="{..image}"
```

8. Modificare il numero di versione del comando successivo per impostare la Label:  
```
oc label deployments viewer-fe-deployment build='0.0.1.412' --overwrite
```
 (la soluzione è estemporaneam, in attesa di allestire un automatismo)

###### Verifiche delle immagini utilizzate da ogni singolo deploy
Si utilizza il comando  
```
oc get deployments -o wide
```

se può fare comodo,  si può redirezionare il risultato su un file:
`oc get deployments -o wide > elenco_deploy.txt`

###### Modifiche massive alla teseo-version-list
Per l'esecuzione di modifiche massive alla configmap teseo-version-list, si può utilizzare il file di supporto [Esecuzione_Deploy_COLL.docx](https://dev.azure.com/Leonardo-Cybersecurity/ENG-Teseo-Next/_git/ENG-Teseo-Next_Documentation?path=/documentation/deployment/Deploy_Collaudo/Esecuzione_Deploy_COLL.docx&version=GBmain)

Nel foglio Dati si aggiornano le versioni dei moduli (Colonna "DevOps", evidenziata in giallo). 
In colonna G ("ConfigMap-TEST") appaiono le voci da copiare e incollare nel file teseo-version-list.

###### Riavvio massivo dei deploy
**cc-teseo**
oc r
ollout restart deployment/analisi-be-deployment
oc rollout restart deployment/analisi-fe-deployment
oc rollout restart deployment/audit-be-deployment
oc rollout restart deployment/authenticationservice-be-deployment
oc rollout restart deployment/container-be-deployment
oc rollout restart deployment/frontend-deployment
oc rollout restart deployment/indagine-be-deployment
oc rollout restart deployment/indagine-fe-deployment
oc rollout restart deployment/ius-be-deployment
oc rollout restart deployment/ius-fe-deployment
oc rollout restart deployment/teseo-ldapservice
oc rollout restart deployment/nominatim-deployment
oc rollout restart deployment/nominatim-geofabrik-mirror-deployment
oc rollout restart deployment/report-be-deployment
oc rollout restart deployment/sag-be-deployment
oc rollout restart deployment/viewer-be-deployment
oc rollout restart deployment/viewer-fe-deployment
oc rollout restart deployment/workflow-be-deployment
oc rollout restart deployment/workflow-fe-deployment

**cc-teseo-svil**
oc rollout restart deployment/teseo-analisi-be
oc rollout restart deployment/teseo-analisi-fe
oc rollout restart deployment/teseo-audit-be
oc rollout restart deployment/teseo-authenticationservice-be
oc rollout restart deployment/teseo-container-be
oc rollout restart deployment/teseo-frontend
oc rollout restart deployment/teseo-indagine-be 
oc rollout restart deployment/teseo-indagine-fe 
oc rollout restart deployment/teseo-ius-be
oc rollout restart deployment/teseo-ius-fe
oc rollout restart deployment/teseo-ldapservice
oc rollout restart deployment/teseo-report-be 
oc rollout restart deployment/teseo-viewer-be 
oc rollout restart deployment/teseo-viewer-fe 
oc rollout restart deployment/teseo-workflow-be 
oc rollout restart deployment/teseo-workflow-fe 







##### ma come si fa?
Sorella, questa è **la domanda giusta**: quando hai **20 repository di codice** e **1 solo insieme di manifest** (deployment, configmap, service…), **non puoi duplicare i manifest** in ogni repo: diventerebbe ingestibile.

La soluzione professionale è chiara:

*Non si “distribuiscono” i manifest alle repo*

###### È l’infrastruttura che “legge” quei manifest da una repo centrale

 Il metodo corretto si chiama **GitOps**

E no: **non si deployano come artifact** (come se fossero jar, pacchetti, o zip).
Con Kubernetes/OKD non funzionerebbe bene.

 SOLUZIONE CORRETTA PER 20 REPO: UNA **REPO INFRASTRUTTURALE** + GitOps

**1 repository globale** contiene i manifest per *tutti* i servizi

Esempio:
```
/infrastructure
    /apps
        /service-A
            deployment.yaml
            service.yaml
            configmap.yaml
        /service-B
            ...
        /service-C
            ...
    /environments
        /dev
           kustomization.yaml
        /prod
           kustomization.yaml
```

Le 20 repo del codice invece sono separate.

---

###### Chi “applica” questi manifest?

Non le tue repo di codice.

È **il cluster stesso**, tramite un sistema GitOps:

**opzioni:
* **ArgoCD**
* **Openshift GitOps** (è ArgoCD integrato in OKD)
* **FluxCD**

###### Come funziona GitOps (spiegazione semplice e precisa)

1. Tu **versioni** tutti i manifest YAML nella repo `/infrastructure`.
2. ArgoCD/Flux **monitora quella repo**.
3. Ogni volta che fai un commit → il cluster **aggiorna automaticamente** i Deployment/Service ecc.
4. Le 20 repo di codice non devono sapere nulla dei manifest.

Quindi:

* **Deployment.yaml** non sta nelle 20 repo
* **configmap.yaml** non sta nelle 20 repo
* Nessuna repo di codice deve “portarsi dietro” i manifest

---

###### Ma allora come fa ogni repo di codice a deployare la nuova versione?

Ottima domanda.

Ci sono due strategie:

- Strategia A — Cambiare il tag dell’immagine via GitOps

(la più pulita e usata)

1. La pipeline CI (GitHub Actions, GitLab CI, Azure DevOps…)
2. builda l’immagine Docker e la pusha nel registry
3. fa una PR/commit **nella repo infrastructure** aggiornando:

```yaml
image: registry/my-service:1.2.8
```

A quel punto ArgoCD vede il cambio → aggiorna il cluster.


- Strategia B — L’infrastruttura punta a un tag “latest” o “stable”

Ma **non è consigliata** in produzione, perché rende tutto meno controllabile.


Risposta diretta alla tua domanda:
*“Come faccio in modo che 20 repository attingano da quei manifest?”*
**Non devono attingere.**
È il cluster (tramite GitOps) che attinge da una repo centrale.


ecco cosa ho trovato.
**Introduction**
File di configurazione per la build su DevOps (cartelle 1_build_CI) e il deploy su OKD (cartelle 2_release_CD)

**Impostazioni generali**
La configMap contenuta in teseo-key-config va montata come un volume, in questo modo

volumeMounts:
      - name: config-volume
        mountPath: /etc/path

definendo il volume così
volumes:
    - name: config-volume
      configMap:
        name: teseonext-key-config

L'altra configMap, contenuta in teseo-general-config, va configurata in maniera classica per valorizzare le variabili di ambiente
 
Nei file application.yaml dei servizi Container e Indagine va poi definito solo l'host (il resto del path è corretto) nella variabile jwk-endpoint

- User, password e chiavi pubblica e privata sono offuscati in un secret
- i secrets chiave-valore vanno su tutti i servizi
- i secrets da montare come volume vanno solo sull'Authentication Service 

- Per quanto riguarda jwk-endpoint, va indicato sui servizi Container e Indagine e deve riportare l'host del servizio authentication: dovrà essere tipo: jwk-endpoint: 'http://authenticationservice-be-route-cc-teseo.apps.clu01.dev.okd.priv/auth/keys/public'

- SIOemulator-be: è semplice perchè non gli serve nessuna configurazione particolare se non montare una configMap come un disco
  -> non ci sono secret

la configMap è questa https://dev.azure.com/Leonardo-Cybersecurity/ENG-Teseo-Next/_git/ENG-Teseo-Next_Deployments?path=/Config_And_Secrets/sio-emulator-config.yaml
e  va montata su /opt/sio

in modo da avere due file:

/opt/sio/authorization_by_app_and_user.json
/opt/sio/profile.json	



finalmente ho ottenuto l'accesso a #OKD (non con le mie credenziali purtoppo... in modo da poter vedere il servizio)

# inizio lavoro su project cc-teseo-SVIL
prima di occuparci delle configmap vediamo gli altri file yaml propedeutici.

primo file è quello di deployment, che è: 
```yaml
kind: Deployment
apiVersion: apps/v1
metadata:
  name: teseo-indagine-be
  namespace: cc-teseo-svil
  labels:
    app: sai
    build: latest
spec:
  replicas: 1
  selector:
    matchLabels:
      app: indagine-be-app
  template:
    metadata:
      labels:
        app: indagine-be-app
    spec:
      volumes:
        - name: config-volume
          secret:
            secretName: teseonext-sai-cert
            defaultMode: 420
        - name: cert-volume
          configMap:
            name: teseo-general-config
            items:
              - key: CertSicotesai11
                path: CertSicotesai11.jks
            defaultMode: 420
      containers:
        - resources: {}
          terminationMessagePath: /dev/termination-log
          name: indagine-be
          env:
            - name: ENV
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: ENV
            - name: DATABASE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: teseonext-secrets
                  key: DATABASE_USERNAME
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: teseonext-secrets
                  key: DATABASE_PASSWORD
            - name: JKS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: teseonext-secrets
                  key: JKS_PASSWORD
            - name: DATABASE_URL
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: DATABASE_URL
            - name: JWK-ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: JWK-ENDPOINT
            - name: TZ
              value: Europe/Rome
            - name: AUDIT-BEAN-NAME
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: AUDIT-BEAN-NAME
            - name: AUDIT-KAFKA-KEY
              valueFrom:
                secretKeyRef:
                  name: teseonext-secrets
                  key: AUDIT-KAFKA-KEY
            - name: KAFKA_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: KAFKA_ENDPOINT
            - name: WORFLOW_COMM_TYPE
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: WORFLOW_COMM_TYPE
            - name: WORKFLOW_BE_URL
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: WORKFLOW_BE_URL
            - name: AUDIT-SECURITY-STRING
              valueFrom:
                secretKeyRef:
                  name: teseonext-secrets
                  key: AUDIT-SECURITY-STRING
            - name: PAST-YEARS-TO-FETCH-FOR-AUDIT
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: PAST-YEARS-TO-FETCH-FOR-AUDIT
            - name: LDAP-URL
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: LDAP-URL
            - name: LDAP-BASE
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: LDAP-BASE
            - name: LDAP-USERNAME
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: LDAP-USERNAME
            - name: LDAP-PASSWORD
              valueFrom:
                secretKeyRef:
                  name: teseonext-secrets
                  key: LDAP-PASSWORD
            - name: REPORT-INTERNAL-URL
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: REPORT-INTERNAL-URL
            - name: SAI-SERVICE-PASSWORD
              valueFrom:
                secretKeyRef:
                  name: teseonext-secrets
                  key: SAI-SERVICE-PASSWORD
            - name: SERVICE-AUTH-REFRESH-ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: SERVICE-AUTH-REFRESH-ENDPOINT
            - name: SERVICE-AUTH-LOGIN-ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: SERVICE-AUTH-LOGIN-ENDPOINT
            - name: CORS_METHODS
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: CORS_METHODS
            - name: CORS_ORIGINS
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: CORS_ORIGINS
            - name: SAF_FOLDER_POSITION
              valueFrom:
                configMapKeyRef:
                  name: teseo-general-config
                  key: SAF_FOLDER_POSITION
            - name: LOG_COMMONS_REQUEST_LOGGING_FILTER
              valueFrom:
                configMapKeyRef:
                  name: teseo-logs-config
                  key: LOG_COMMONS_REQUEST_LOGGING_FILTER
            - name: LOG_HIBERNATE
              valueFrom:
                configMapKeyRef:
                  name: teseo-logs-config
                  key: LOG_HIBERNATE
            - name: LOG_HIBERNATE_CACHE
              valueFrom:
                configMapKeyRef:
                  name: teseo-logs-config
                  key: LOG_HIBERNATE_CACHE
            - name: LOG_HIBERNATE_ORM_JDBC_BIND
              valueFrom:
                configMapKeyRef:
                  name: teseo-logs-config
                  key: LOG_HIBERNATE_ORM_JDBC_BIND
            - name: LOG_HIBERNATE_SQL
              valueFrom:
                configMapKeyRef:
                  name: teseo-logs-config
                  key: LOG_HIBERNATE_SQL
            - name: LOG_HIBERNATE_SQL_SLOW
              valueFrom:
                configMapKeyRef:
                  name: teseo-logs-config
                  key: LOG_HIBERNATE_SQL_SLOW
            - name: LOG_HIBERNATE_STAT
              valueFrom:
                configMapKeyRef:
                  name: teseo-logs-config
                  key: LOG_HIBERNATE_STAT
            - name: LOG_TESEO
              valueFrom:
                configMapKeyRef:
                  name: teseo-logs-config
                  key: LOG_TESEO
            - name: ANT-INTEGRATION-ENABLED
              value: 'true'
            - name: ANT-REST-API-ENDPOINT
              value: https://10.129.63.35/teseo/antbe/pabe/ant
            - name: ANT-KAFKA-REQUEST-TOPIC-NAME
              value: TeseoAntRequest
            - name: ANT-KAFKA-RESPONSE-TOPIC-NAME
              value: TeseoAntResponse
            - name: ANT-KAFKA-ENDPOINT
              value: 10.129.63.10:9094
            - name: ANT-KAFKA-GROUP-ID
              value: sai
            - name: DOMAIN_ADMIN_USER
              value: SCT\Administrator
          ports:
            - containerPort: 8080
              protocol: TCP
          imagePullPolicy: Always
          volumeMounts:
            - name: cert-volume
              mountPath: /etc/cert
            - name: config-volume
              mountPath: /etc/path
          terminationMessagePolicy: File
          image: 'sicotecr.azurecr.io/teseo/indagine-be:latest'
      restartPolicy: Always
      imagePullSecrets:
        - name: sicotecr.azurecr.io
      hostAliases:
        - ip: 10.0.117.11
          hostnames:
            - cgeng01rteseo.rete.arma.carabinieri.it
        - ip: 10.129.51.64
          hostnames:
            - sctengsrv04
```

poi abbiamo quello dei servizi: 
```yaml
kind: Service
apiVersion: v1
metadata:
  name: indagine-be
  namespace: cc-teseo-svil
spec:
  ports:
    - name: 8080-tcp
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app: indagine-be-app
```

e quello della rotta: 
```yaml
kind: Route
apiVersion: route.openshift.io/v1
metadata:
  name: indagine-be-route
  namespace: cc-teseo-svil
  labels: {}
spec:
  to:
    kind: Service
    name: indagine-be
  tls: null
  path: /
  port:
    targetPort: 8080

```

